---
layout: post
title:  "Invoke-DbaQuery"
author: Tinu
categories: "PowerShell-SQL"
tags:   PowerShell News
permalink: /posts/:title:output_ext
---

# Table of Contents

- [Table of Contents](#table-of-contents)
- [Invoke-SqlCmd with dbatools](#invoke-sqlcmd-with-dbatools)
- [See also](#see-also)

# Invoke-SqlCmd with dbatools

````powershell
[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [String] $SqlInstance = 'MySQLInstance',

    [Parameter(Mandatory=$false)]
    [String] $Database = 'MyDatabase',

    [Parameter(Mandatory=$false)]
    [DateTime] $DateFrom = (Get-Date).AddDays(-10)
)

Begin{
$SqlQuery = @"
USE [$($Database)]
GO
 
SELECT * 
FROM [dbo].[Table]
WHERE Value LIKE '%offline%' and DateTime >= '$($DateFrom)' and FQDN NOT LIKE '%tinu%'
ORDER BY DateTime
"@
}

Process{

    if(-not($MySqlCredentials)){
        $MySqlCredentials = Get-Credential -Message "Enter the user to connect to $MySQLInstance" -UserName "$($env:USERDNSDOMAIN)\$($env:USERNAME)"
    }
    try{
        $StartDate       = Get-Date
        $result          = Invoke-DbaQuery -SqlInstance $MySQLInstance -SqlCredential $MySqlCredentials -Database $Database -Query $SqlQuery
        $EndDate         = Get-Date
        $TotalMS         = "{0:N0}" -f (New-TimeSpan –Start $StartDate –End $EndDate | Select-Object -ExpandProperty MilliSeconds)
    }
    catch{
        Write-Host "An error occured, details:" -ForegroundColor Red
        [PSCustomObject]@{
            Activity   = $($_.CategoryInfo).Activity
            Message    = $($_.Exception.Message)
            Category   = $($_.CategoryInfo).Category
            Exception  = $($_.Exception.GetType().FullName)
            TargetName = $($_.CategoryInfo).TargetName
        }        
        $Error.clear()
        $MySqlCredentials = $null
    }
}

End{
    Write-Host "[$($TotalMS)ms] Query return $($result.count) rows" -ForegroundColor Green
    return ($result | Select DateTime,FQDN,Value)
}
````

# See also

[dbatools Invoke-DbaQuery](https://docs.dbatools.io/#Invoke-DbaQuery)

[ [Top](#table-of-contents) ] [ [Blog](../categories.html) ]